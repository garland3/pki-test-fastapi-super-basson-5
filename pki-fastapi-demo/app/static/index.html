<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PKI Demo</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    header { display:flex; align-items:center; gap:.75rem; }
    h1 { margin: 0; font-size: 1.5rem; }
    .card { border: 1px solid #8884; border-radius: 8px; padding: 1rem; margin: 1rem 0; }
    code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .ok { color: #0a0; }
    .bad { color: #a00; }
    button { padding: .5rem .75rem; border-radius: 6px; border: 1px solid #8884; cursor: pointer; }
  </style>
</head>
<body>
  <header>
    <img src="/static/lock.svg" alt="lock" width="28" height="28" />
    <h1>FastAPI + NGINX mTLS Demo</h1>
  </header>

  <div class="card">
    <h2>Health</h2>
    <button id="btnHealth">Check /api/health</button>
    <div id="health"></div>
  </div>

  <div class="card">
    <h2>Who am I?</h2>
    <p>Requires a verified client certificate. Your browser should prompt you to choose a cert.</p>
    <button id="btnMe">Call /api/me</button>
    <pre id="me"></pre>
  </div>

  <div class="card">
    <h2>Protected route</h2>
    <p>
      Direct link to protected endpoint (requires a client certificate):
      <a href="/api/protected" target="_blank" rel="noopener">/api/protected</a>
    </p>
  </div>

  <div class="card">
    <h2>Protected page (HTML)</h2>
    <p>
      Shows whether the server confirmed your identity:
      <a href="/protected" target="_blank" rel="noopener">/protected</a>
    </p>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
  $("btnHealth").addEventListener("click", async () => {
      $("health").textContent = "...";
      try {
    const res = await fetch("/health");
        const data = await res.json();
        $("health").innerHTML = `<span class="${data.ok ? 'ok' : 'bad'}">${JSON.stringify(data)}</span>`;
      } catch (e) {
        $("health").textContent = String(e);
      }
    });

    $("btnMe").addEventListener("click", async () => {
      $("me").textContent = "...";
      try {
        const res = await fetch("/api/me", { credentials: "include" });
        if (res.status === 403 || res.status === 401) {
          $("me").textContent = `Denied (${res.status}). Make sure a client certificate is selected and trusted.`;
          return;
        }
        const data = await res.json();
        $("me").textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        $("me").textContent = String(e);
      }
    });
  </script>
</body>
</html>
